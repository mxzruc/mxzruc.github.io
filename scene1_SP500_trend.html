<!--https://ncoughlin.com/posts/d3-line-chart#tooltip-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SP500 Trend</title>
    <script src='https://d3js.org/d3.v7.min.js'></script>

    <style>

        #tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 10px sans-serif;
            background: none;
            /*border: 1px solid #000;*/
            border-radius: 4px;
            pointer-events: none;
        }

        .annotation {
            fill: white;
            stroke: black;
            stroke-width: 1px;
        }
        .annotation-text {
            font: 12px sans-serif;
            fill: black;
        }
    </style>


    <script>

        async function draw() {
// Data
            const dataset = await d3.csv("spy500_index_value.csv");
// Accessors
            const parseDate = d3.timeParse("%Y-%m-%d");
            const xAccessor = (d) => parseDate(d.date);
            const yAccessor = (d) => parseInt(d.close);

// Dimensions
            let dimensions = {
                width: 1000,
                height: 500,
                margins: 50,
            };

            dimensions.containerWidth = dimensions.width - dimensions.margins * 2;
            dimensions.containerHeight = dimensions.height - dimensions.margins * 2;

// Draw Image
            const svg = d3
                .select("#chart")
                .append("svg")
                .attr("width", dimensions.width)
                .attr("height", dimensions.height);

// Selections
            const container = svg
                .append("g")
                .attr(
                    "transform",
                    `translate(${dimensions.margins}, ${dimensions.margins})`
                );

            const tooltip = d3.select("#tooltip");
            const tooltipDot = container
                .append("circle")
                .attr("r", 5)
                .attr("fill", "#fc8781")
                .attr("stroke", "black")
                .attr("stroke-width", 2)
                .style("opacity", 0)
                .style("pointer-events", "none");

// Scales
            const yScale = d3
                .scaleLinear()
                .domain(d3.extent(dataset, yAccessor))
                .range([dimensions.containerHeight, 0])
                .nice();

            const xScale = d3
                .scaleTime()
                .domain(d3.extent(dataset, xAccessor))
                .range([0, dimensions.containerWidth]);

// Line Generator
            const lineGenerator = d3
                .line()
                .x((d) => xScale(xAccessor(d)))
                .y((d) => yScale(yAccessor(d)));

// Line
            container
                .append("path")
                .datum(dataset)
                .attr("d", lineGenerator)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 1.5)
                // .attr("stroke", "#30475e")
                // .attr("stroke-width", 2);

// Axis
            const yAxis = d3.axisLeft(yScale).tickFormat(d3.format("d"));

            container.append("g").classed("yAxis", true).call(yAxis);

            const xAxis = d3.axisBottom(xScale);

            container
                .append("g")
                .classed("xAxis", true)
                .style("transform", `translateY(${dimensions.containerHeight}px)`)
                .call(xAxis);

            container.append("text")
                .attr("transform", "translate(" + (dimensions.width/2) + " , 0)")
                .style("text-anchor", "middle")
                .text("Daily Index Value");

// Tooltip
            container
                .append("rect")
                .attr("width", dimensions.containerWidth)
                .attr("height", dimensions.containerHeight)
                .style("opacity", 0)
                .on("touchmouse mousemove", function (event) {
                    const mousePos = d3.pointer(event, this);
// x coordinate stored in mousePos index 0
                    const date = xScale.invert(mousePos[0]);

// Custom Bisector - left, center, right
                    const dateBisector = d3.bisector(xAccessor).left;
                    const bisectionIndex = dateBisector(dataset, date);
// math.max prevents negative index reference error
                    const hoveredIndexData = dataset[Math.max(0, bisectionIndex - 1)];

// Update Image
                    tooltipDot
                        .style("opacity", 1)
                        .attr("cx", xScale(xAccessor(hoveredIndexData)))
                        .attr("cy", yScale(yAccessor(hoveredIndexData)))
                        .raise();

                    tooltip
                        .style("display", "block")
                        .style("top", `${yScale(yAccessor(hoveredIndexData))}px`)
                        .style("left", `${xScale(xAccessor(hoveredIndexData))}px`);

                    tooltip.select(".price")
                        // .text(`${yAccessor(hoveredIndexData)}`)
                        .html(`Index Value: ${yAccessor(hoveredIndexData)}`);

                    const dateFormatter = d3.timeFormat("%Y-%m-%d");

                    tooltip.select(".date")
                        // .text(`${dateFormatter(xAccessor(hoveredIndexData))}`)
                        .html(`Date: ${dateFormatter(xAccessor(hoveredIndexData))}`)
                })
                .on("mouseleave", function () {
                    tooltipDot.style("opacity", 0);
                    tooltip.style("display", "none");
                });


            // Add annotation box
            const annotationWidth = 150;
            const annotationHeight = 50;
            svg.append("rect")
                .attr("class", "annotation")
                .attr("x", 60)
                .attr("y", 50)
                .attr("width", annotationWidth)
                .attr("height", annotationHeight);

            svg.append("text")
                .attr("class", "annotation-text")
                .attr("x", 65)
                .attr("y", 70)
                .text("10-year avg annual return");

            svg.append("text")
                .attr("class", "annotation-text")
                .attr("x", 95)
                .attr("y", 90)
                .text("12.58%")
                .attr("text-anchor", "right");

        }

        draw();

    </script>

</head>

<body>
<div id="chart">
    <div id="tooltip">
        <div class="price"></div>
        <div class="date"></div>
    </div>
</div>

</body>
</html>